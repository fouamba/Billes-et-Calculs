
PLAN DE MIGRATION :

## üìä Analyse de l'existant

### Structure actuelle
```
Billes-et-Calculs/
‚îú‚îÄ‚îÄ frontend/              # Next.js (TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ src/              # Code source application
‚îÇ   ‚îú‚îÄ‚îÄ prisma/           # ‚ö†Ô∏è ORM √† remplacer par Supabase
‚îÇ   ‚îú‚îÄ‚îÄ public/           # Assets statiques
‚îÇ   ‚îú‚îÄ‚îÄ docs/             # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ playwright.config.ts  # Tests E2E ‚úÖ
‚îÇ   ‚îú‚îÄ‚îÄ jest.config.json      # Tests unitaires ‚úÖ
‚îÇ   ‚îî‚îÄ‚îÄ next.config.ts        # Config Next.js
‚îú‚îÄ‚îÄ backend/              # ‚ùì Vide - √Ä d√©finir
‚îú‚îÄ‚îÄ analytics/R/          # Scripts R pour RStudio ‚úÖ
‚îú‚îÄ‚îÄ prisma/               # ‚ö†Ô∏è Doublon racine projet
‚îî‚îÄ‚îÄ docker-compose.yml    # Dev local
```

### Points cl√©s identifi√©s

**‚úÖ √Ä conserver :**
- Structure Next.js compl√®te
- Configuration tests (Playwright + Jest)
- Scripts R analytics
- Docker Compose pour dev local

**‚ö†Ô∏è √Ä migrer :**
- **Prisma ‚Üí Supabase Client**
  - Remplacer sch√©ma Prisma par sch√©ma SQL Supabase
  - Remplacer `prisma.user.findMany()` par `supabase.from('users').select()`
  - Conserver les types TypeScript

**‚ùå √Ä supprimer :**
- Dossier `prisma/` racine (doublon)
- `frontend/prisma/` (apr√®s migration compl√®te)

**‚ûï √Ä ajouter :**
- Configuration Supabase dans frontend
- Scripts d√©ploiement Coolify
- Connexion Learning Locker (xAPI)
- Int√©gration Ollama (IA)

## üèóÔ∏è Nouvelle architecture cible

### Frontend (Next.js sur Vercel)

```
frontend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                    # App Router Next.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (auth)/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/page.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ register/page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (game)/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ level-1/page.tsx    # Client Component 3D
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ level-2/page.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ level-3/page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (teacher)/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/page.tsx  # Server Component
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ students/page.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analytics/page.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adaptive/route.ts   # Proxy Ollama
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ xapi/route.ts       # Proxy Learning Locker
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                # Landing (SSR)
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ game/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GameScene.tsx       # Canvas 3D
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BallPhysics.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TeacherAvatar.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProblemUI.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ teacher/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AnalyticsChart.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StudentList.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SessionHistory.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui/                     # Shadcn components
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts           # Client-side
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server.ts           # Server-side
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ middleware.ts       # Edge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ xapi/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ statements.ts       # xAPI helpers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ adaptive.ts         # IA adaptative
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îÇ   ‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gameStore.ts            # Zustand game state
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ teacherStore.ts
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.types.ts       # Generated by Supabase
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ game.types.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ xapi.types.ts
‚îÇ   ‚îî‚îÄ‚îÄ hooks/
‚îÇ       ‚îú‚îÄ‚îÄ useAdaptiveDifficulty.ts
‚îÇ       ‚îú‚îÄ‚îÄ useGameSession.ts
‚îÇ       ‚îî‚îÄ‚îÄ useXAPI.ts
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ models/                     # 3D models (GLB/GLTF)
‚îÇ   ‚îú‚îÄ‚îÄ sounds/                     # Audio feedback
‚îÇ   ‚îî‚îÄ‚îÄ icons/
‚îú‚îÄ‚îÄ supabase/                       # ‚ö†Ô∏è Nouveau
‚îÇ   ‚îú‚îÄ‚îÄ migrations/                 # SQL migrations
‚îÇ   ‚îî‚îÄ‚îÄ seed.sql                    # Donn√©es initiales
‚îú‚îÄ‚îÄ middleware.ts                   # Auth middleware
‚îú‚îÄ‚îÄ next.config.ts
‚îî‚îÄ‚îÄ package.json
```

### Backend (Coolify auto-h√©berg√©)

```
D√©ploy√© via Coolify:
‚îú‚îÄ‚îÄ Supabase Stack
‚îÇ   ‚îú‚îÄ‚îÄ PostgreSQL 15
‚îÇ   ‚îú‚îÄ‚îÄ PostgREST (API auto)
‚îÇ   ‚îú‚îÄ‚îÄ GoTrue (Auth)
‚îÇ   ‚îú‚îÄ‚îÄ Realtime (WebSocket)
‚îÇ   ‚îî‚îÄ‚îÄ Storage (S3-like)
‚îú‚îÄ‚îÄ Learning Locker
‚îÇ   ‚îú‚îÄ‚îÄ MongoDB (statements)
‚îÇ   ‚îú‚îÄ‚îÄ Redis (cache)
‚îÇ   ‚îî‚îÄ‚îÄ API xAPI
‚îú‚îÄ‚îÄ Ollama
‚îÇ   ‚îú‚îÄ‚îÄ Gemma 2B
‚îÇ   ‚îú‚îÄ‚îÄ Llama 3.2 3B
‚îÇ   ‚îî‚îÄ‚îÄ Phi-3 Mini
‚îî‚îÄ‚îÄ RStudio Server
    ‚îî‚îÄ‚îÄ Scripts R analytics
```

## üîÑ Plan de migration d√©taill√©

### Phase 1 : Pr√©paration infrastructure (Semaine 1)

#### 1.1 D√©ploiement Coolify

```bash
# Sur votre serveur Coolify
# 1. D√©ployer Supabase
coolify deploy supabase \
  --postgres-password="votre_mot_de_passe_fort" \
  --jwt-secret="$(openssl rand -base64 32)" \
  --anon-key="$(supabase keys generate anon)" \
  --service-role-key="$(supabase keys generate service_role)"

# 2. D√©ployer Learning Locker
coolify deploy learning-locker \
  --mongo-password="mot_de_passe_mongo" \
  --app-secret="$(openssl rand -base64 32)"

# 3. D√©ployer Ollama
coolify deploy ollama \
  --memory=8G \
  --models="gemma2:2b,llama3.2:3b,phi3:mini"

# 4. D√©ployer RStudio
coolify deploy rstudio \
  --password="mot_de_passe_rstudio"
```

#### 1.2 Configuration DNS

```
supabase.ceredis.net  ‚Üí IP Coolify (port 8000)
lrs.ceredis.net       ‚Üí IP Coolify (port 8080)
rstudio.ceredis.net   ‚Üí IP Coolify (port 8787)
```

### Phase 2 : Migration Prisma ‚Üí Supabase (Semaine 2)

#### 2.1 Extraire le sch√©ma Prisma existant

```bash
cd frontend
# G√©n√©rer le SQL depuis Prisma
npx prisma migrate diff \
  --from-empty \
  --to-schema-datamodel prisma/schema.prisma \
  --script > supabase/migrations/00_init.sql
```

#### 2.2 Adapter pour Supabase

```sql
-- supabase/migrations/01_initial_schema.sql

-- Extension UUID
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Users (g√©r√© par Supabase Auth automatiquement)
-- auth.users existe d√©j√†

-- Student Profiles
CREATE TABLE student_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  date_of_birth DATE,
  class_id UUID REFERENCES classes(id),
  adaptive_level INTEGER DEFAULT 1 CHECK (adaptive_level BETWEEN 1 AND 3),
  current_max_value INTEGER DEFAULT 5,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Classes
CREATE TABLE classes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  teacher_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  school_year TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Game Sessions
CREATE TABLE game_sessions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  level INTEGER NOT NULL CHECK (level BETWEEN 1 AND 3),
  module INTEGER DEFAULT 1,
  start_time TIMESTAMPTZ DEFAULT NOW(),
  end_time TIMESTAMPTZ,
  score INTEGER DEFAULT 0,
  problems_attempted INTEGER DEFAULT 0,
  problems_correct INTEGER DEFAULT 0,
  badge_earned BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Problems Attempted
CREATE TABLE problems_attempted (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID REFERENCES game_sessions(id) ON DELETE CASCADE,
  problem_number INTEGER NOT NULL,
  problem_type TEXT NOT NULL CHECK (problem_type IN ('composition', 'decomposition')),
  total_value INTEGER NOT NULL,
  part1_value INTEGER NOT NULL,
  part2_value INTEGER NOT NULL,
  unknown_position TEXT NOT NULL CHECK (unknown_position IN ('total', 'part1', 'part2')),
  user_answer INTEGER,
  expected_answer INTEGER NOT NULL,
  is_correct BOOLEAN,
  attempts INTEGER DEFAULT 1,
  duration_ms INTEGER,
  hints_requested INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Badges
CREATE TABLE badges (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT UNIQUE NOT NULL,
  description TEXT,
  icon_url TEXT,
  criteria JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE user_badges (
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  badge_id UUID REFERENCES badges(id) ON DELETE CASCADE,
  earned_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (user_id, badge_id)
);

-- Strategies (pour recherche)
CREATE TABLE strategies_detected (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  problem_id UUID REFERENCES problems_attempted(id) ON DELETE CASCADE,
  strategy_type TEXT NOT NULL,
  confidence DECIMAL(3,2) DEFAULT 0.5,
  detected_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes pour performance
CREATE INDEX idx_sessions_user ON game_sessions(user_id, created_at DESC);
CREATE INDEX idx_problems_session ON problems_attempted(session_id, problem_number);
CREATE INDEX idx_student_profiles_class ON student_profiles(class_id);

-- Row Level Security (RLS)
ALTER TABLE student_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE game_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE problems_attempted ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_badges ENABLE ROW LEVEL SECURITY;

-- Policies: Students see only their data
CREATE POLICY "Students view own profile"
  ON student_profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Students view own sessions"
  ON game_sessions FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Students insert own sessions"
  ON game_sessions FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Students view own problems"
  ON problems_attempted FOR SELECT
  USING (
    session_id IN (
      SELECT id FROM game_sessions WHERE user_id = auth.uid()
    )
  );

-- Policies: Teachers see their students
CREATE POLICY "Teachers view their students"
  ON student_profiles FOR SELECT
  USING (
    class_id IN (
      SELECT id FROM classes WHERE teacher_id = auth.uid()
    )
  );

CREATE POLICY "Teachers view their classes sessions"
  ON game_sessions FOR SELECT
  USING (
    user_id IN (
      SELECT id FROM student_profiles 
      WHERE class_id IN (
        SELECT id FROM classes WHERE teacher_id = auth.uid()
      )
    )
  );

-- Functions utilitaires
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_student_profiles_updated_at
  BEFORE UPDATE ON student_profiles
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();
```

#### 2.3 G√©n√©rer types TypeScript

```bash
# Installer Supabase CLI
npm install -g supabase

# Se connecter au projet Supabase
supabase link --project-ref votre-project-ref

# G√©n√©rer les types
supabase gen types typescript --project-id votre-project-ref > src/types/database.types.ts
```

#### 2.4 Remplacer Prisma Client par Supabase

**Avant (Prisma) :**
```typescript
// lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

export async function getStudents() {
  return await prisma.studentProfile.findMany({
    include: { gameSessions: true }
  })
}
```

**Apr√®s (Supabase) :**
```typescript
// lib/supabase/client.ts
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { Database } from '@/types/database.types'

export const createClient = () => createClientComponentClient<Database>()

// lib/supabase/server.ts
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { Database } from '@/types/database.types'

export const createServerClient = () => 
  createServerComponentClient<Database>({ cookies })

// Usage dans Server Component
export async function getStudents() {
  const supabase = createServerClient()
  
  const { data, error } = await supabase
    .from('student_profiles')
    .select(`
      *,
      game_sessions(*)
    `)
  
  if (error) throw error
  return data
}
```

### Phase 3 : Int√©gration des nouvelles fonctionnalit√©s (Semaines 3-4)

#### 3.1 Configuration xAPI (Learning Locker)

```typescript
// lib/xapi/client.ts
import TinCan from 'tincanjs'

const lrs = new TinCan.LRS({
  endpoint: process.env.NEXT_PUBLIC_LRS_ENDPOINT!,
  username: process.env.NEXT_PUBLIC_LRS_KEY!,
  password: process.env.NEXT_PUBLIC_LRS_SECRET!,
  allowFail: false
})

export async function sendStatement(statement: TinCan.Statement) {
  return new Promise((resolve, reject) => {
    lrs.saveStatement(statement, {
      callback: (err, xhr) => {
        if (err) reject(err)
        else resolve(xhr)
      }
    })
  })
}

// lib/xapi/statements.ts
import { sendStatement } from './client'

export async function trackProblemAnswered({
  studentEmail,
  studentName,
  problemId,
  problemDescription,
  isCorrect,
  userAnswer,
  level,
  problemType,
  attempts,
  durationMs
}: ProblemAnsweredParams) {
  const statement = {
    actor: {
      mbox: `mailto:${studentEmail}`,
      name: studentName
    },
    verb: {
      id: 'http://adlnet.gov/expapi/verbs/answered',
      display: { 'fr-FR': 'a r√©pondu' }
    },
    object: {
      id: `http://billes-calculs.fr/problem/${problemId}`,
      definition: {
        name: { 'fr-FR': 'Probl√®me de structure additive' },
        description: { 'fr-FR': problemDescription },
        type: 'http://adlnet.gov/expapi/activities/cmi.interaction'
      }
    },
    result: {
      success: isCorrect,
      response: String(userAnswer),
      duration: `PT${(durationMs / 1000).toFixed(1)}S`,
      score: {
        scaled: isCorrect ? 1 : 0
      }
    },
    context: {
      extensions: {
        'http://billes-calculs.fr/extensions/level': level,
        'http://billes-calculs.fr/extensions/problem-type': problemType,
        'http://billes-calculs.fr/extensions/attempts': attempts
      }
    }
  }
  
  await sendStatement(statement)
}
```

#### 3.2 Int√©gration IA Adaptative (Ollama)

```typescript
// app/api/adaptive/hint/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'

export async function POST(request: NextRequest) {
  const supabase = createRouteHandlerClient({ cookies })
  
  // Auth check
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  
  const { problemContext, recentErrors } = await request.json()
  
  // Appel Ollama via Supabase Edge Function
  const { data, error } = await supabase.functions.invoke('adaptive-hint', {
    body: { 
      userId: session.user.id,
      problemContext, 
      recentErrors 
    }
  })
  
  if (error) {
    console.error('Ollama error:', error)
    return NextResponse.json({ error: 'IA unavailable' }, { status: 500 })
  }
  
  // Track hint in xAPI
  await trackHintRequested({
    studentEmail: session.user.email!,
    studentName: session.user.user_metadata.full_name,
    problemId: problemContext.id,
    hintText: data.hint
  })
  
  return NextResponse.json(data)
}

// Hook React pour utiliser l'IA
// hooks/useAdaptiveHint.ts
import { useMutation } from '@tanstack/react-query'

export function useAdaptiveHint() {
  return useMutation({
    mutationFn: async ({ problemContext, recentErrors }) => {
      const res = await fetch('/api/adaptive/hint', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ problemContext, recentErrors })
      })
      
      if (!res.ok) throw new Error('Failed to get hint')
      return res.json()
    }
  })
}
```

#### 3.3 Supabase Edge Function (interface avec Ollama)

```typescript
// supabase/functions/adaptive-hint/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const OLLAMA_URL = Deno.env.get('OLLAMA_URL') || 'http://ollama:11434'

serve(async (req) => {
  try {
    const { userId, problemContext, recentErrors } = await req.json()
    
    // R√©cup√©rer contexte √©tudiant depuis BDD
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    )
    
    const { data: history } = await supabase
      .from('problems_attempted')
      .select('*')
      .eq('session_id', (
        await supabase
          .from('game_sessions')
          .select('id')
          .eq('user_id', userId)
          .order('created_at', { ascending: false })
          .limit(1)
          .single()
      ).data.id)
      .order('created_at', { ascending: false })
      .limit(5)
    
    // Construire prompt contextuel
    const prompt = `Tu es un tuteur p√©dagogique bienveillant pour un √©l√®ve de CP (6-7 ans).

Probl√®me actuel: ${problemContext.description}
Valeurs: total=${problemContext.total}, part1=${problemContext.part1}, part2=${problemContext.part2}

Historique r√©cent:
${history?.map(h => `- ${h.problem_type}: ${h.is_correct ? '‚úì' : '‚úó'} (${h.attempts} essais)`).join('\n')}

G√©n√®re un SEUL indice progressif et bienveillant (1-2 phrases maximum), sans donner la r√©ponse directement.
Adapte le vocabulaire √† un enfant de 6 ans.`

    // Appel Ollama
    const response = await fetch(`${OLLAMA_URL}/api/generate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'gemma2:2b',
        prompt,
        stream: false,
        options: {
          temperature: 0.7,
          num_predict: 100
        }
      })
    })
    
    const { response: hint } = await response.json()
    
    return new Response(JSON.stringify({ hint }), {
      headers: { 'Content-Type': 'application/json' }
    })
    
  } catch (error) {
    console.error('Edge function error:', error)
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    })
  }
})
```

### Phase 4 : Tests et d√©ploiement (Semaine 5)

#### 4.1 Tests automatis√©s

```typescript
// __tests__/game/problem-generation.test.ts
import { describe, it, expect } from '@jest/globals'
import { generateProblem } from '@/lib/game/problemGenerator'

describe('Problem Generation', () => {
  it('should generate composition problem', () => {
    const problem = generateProblem('composition', 10)
    
    expect(problem.type).toBe('composition')
    expect(problem.total).toBeLessThanOrEqual(10)
    expect(problem.part1 + problem.part2).toBe(problem.total)
    expect(problem.unknownPosition).toBe('total')
  })
  
  it('should generate decomposition problem', () => {
    const problem = generateProblem('decomposition', 10)
    
    expect(problem.type).toBe('decomposition')
    expect(problem.unknownPosition).toMatch(/part1|part2/)
  })
})

// __tests__/e2e/game-flow.spec.ts (Playwright)
import { test, expect } from '@playwright/test'

test('complete game session level 1', async ({ page }) => {
  // Login
  await page.goto('/login')
  await page.fill('[name="email"]', 'student@test.fr')
  await page.fill('[name="password"]', 'password')
  await page.click('button[type="submit"]')
  
  // Start level 1
  await page.goto('/game/level-1')
  await expect(page.locator('canvas')).toBeVisible()
  
  // Complete 5 problems
  for (let i = 0; i < 5; i++) {
    await page.waitForSelector('[data-testid="problem-input"]')
    await page.fill('[data-testid="problem-input"]', '5')
    await page.click('[data-testid="submit-answer"]')
    await page.waitForTimeout(2000) // Animation feedback
  }
  
  // Check badge earned
  await expect(page.locator('[data-testid="badge-notification"]')).toBeVisible()
})
```

#### 4.2 Configuration Vercel

```json
// vercel.json
{
  "buildCommand": "cd frontend && npm run build",
  "outputDirectory": "frontend/.next",
  "framework": "nextjs",
  "installCommand": "cd frontend && npm install",
  "env": {
    "NEXT_PUBLIC_SUPABASE_URL": "@supabase-url",
    "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase-anon-key",
    "NEXT_PUBLIC_LRS_ENDPOINT": "@lrs-endpoint",
    "NEXT_PUBLIC_LRS_KEY": "@lrs-key",
    "NEXT_PUBLIC_LRS_SECRET": "@lrs-secret"
  },
  "regions": ["cdg1"]
}
```

```bash
# D√©ploiement
cd frontend
vercel --prod

# Configuration variables
vercel env add NEXT_PUBLIC_SUPABASE_URL production
vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY production
# ... autres variables
```

## üìù Checklist de migration compl√®te

### Infrastructure
- [ ] Coolify configur√© et accessible
- [ ] Supabase d√©ploy√© sur Coolify
- [ ] Learning Locker d√©ploy√©
- [ ] Ollama d√©ploy√© avec mod√®les
- [ ] RStudio Server d√©ploy√©
- [ ] DNS configur√©s (4 sous-domaines)
- [ ] SSL Let's Encrypt actif

### Base de donn√©es
- [ ] Migration SQL Supabase ex√©cut√©e
- [ ] RLS policies test√©es
- [ ] Indexes cr√©√©s
- [ ] Donn√©es de test ins√©r√©es
- [ ] Backup automatique configur√©

### Frontend
- [ ] Prisma supprim√© compl√®tement
- [ ] Supabase Client int√©gr√©
- [ ] xAPI client configur√©
- [ ] Middleware auth fonctionnel
- [ ] Types TypeScript g√©n√©r√©s
- [ ] Components 3D migr√©s
- [ ] Tests passent (Jest + Playwright)

### Fonctionnalit√©s
- [ ] Authentification (login/register)
- [ ] Jeu niveau 1 fonctionnel
- [ ] Jeu niveau 2 fonctionnel
- [ ] Jeu niveau 3 fonctionnel
- [ ] IA adaptative op√©rationnelle
- [ ] xAPI tracking actif
- [ ] Dashboard enseignant
- [ ] Syst√®me badges

### D√©ploiement
- [ ] Frontend d√©ploy√© sur Vercel
- [ ] Variables d'environnement configur√©es
- [ ] CI/CD GitHub Actions (optionnel)
- [ ] Monitoring Grafana actif
- [ ] Logs Loki fonctionnels
- [ ] Documentation mise √† jour

## üéØ Prochaines √©tapes imm√©diates

1. **G√©n√©rer le code de migration complet** (remplacement Prisma ‚Üí Supabase) 
2. **Cr√©er les scripts de d√©ploiement Coolify** d√©taill√©s 
3. **D√©velopper les composants manquants** (3D, dashboard, etc.)
4. **√âtablir un planning d√©taill√© semaine par semaine** 
